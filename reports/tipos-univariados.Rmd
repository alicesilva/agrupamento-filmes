---
title: "Tipos de filme de Julia Roberts"
output:
    html_document:
    df_print: paged
theme: sandstone
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(cluster)
library(plotly)
library(ggdendro)
library(broom)
library(ggpubr)

source(here::here("code/lib.R"))
theme_set(theme_report())

knitr::opts_chunk$set(tidy = FALSE,
                      fig.width = 6,
                      fig.height = 5,
                      echo = TRUE)

paleta = c("#404E4D",
           "#92DCE5",
           "#938BA1",
           "#2D3142",
           "#F4743B")
```

Neste relatório, iremos explorar os dados da atriz Julia Roberts. Os dados foram extraídos do [RottenTomatoes](https://www.rottentomatoes.com/).

```{r}
## ANTES DE USAR
# Para criar data/movies.csv
import_data("julia_roberts") # ou com o ator/atriz que você escolher
```


```{r read}
filmes = read_imported_data()
```

## Descrição

O objetivo aqui, é fazer um agrupamento dos filmes da atriz levando em consideração duas variáveis: bilheteria e avaliação.
</br>
Primeiro, vamos analisar separadamente cada uma dessas variáveis, utilizaremos também o ano de lançamento de cada filme para observar a variação durante o tempo.

```{r, warning=FALSE}
p = filmes %>% 
    ggplot(aes(size = 3, x = ano, 
               y = bilheteria, 
               text = paste("Filme:",filme,
                            "\nBilheteria:",
                            bilheteria,"m",
                            "\nAvaliação:", avaliacao,
                            "\nAno:",ano))) +
    geom_point(color = paleta[1]) +
    labs(title = "Variação da bilheteria ao longo dos anos", y = "Bilheteria", x = "Ano de lançamento")
ggplotly(p, tooltip = "text")
```

```{r}
p = filmes %>% 
    ggplot(aes(size = 3, x = ano, 
               y = avaliacao, 
               text = paste("Filme:",filme,
                            "\nBilheteria:",
                            bilheteria,"m",
                            "\nAvaliação:", avaliacao,
                            "\nAno:",ano))) +
    geom_point(color = paleta[5]) +
    labs(title = "Variação da avaliação ao longo dos anos", y = "Avaliação", x = "Ano de lançamento")
ggplotly(p, tooltip = "text")
```

```{r}
p = filmes %>% 
    ggplot(aes(x = "", y = bilheteria, text = paste("Filme:",filme,
                            "\nBilheteria:",
                            bilheteria,"m"))) + 
    geom_jitter(width = .05, alpha = .3, size = 3) + 
    labs(x = "", y="Bilheteria")
ggplotly(p, tooltip="text")
```
```{r}
m_transformado = filmes %>% 
    mutate(b = log10(bilheteria))
summary(m_transformado %>% select(bilheteria, b))
```

```{r}
n_clusters = 4
km = m_transformado %>% 
    select(b, avaliacao) %>% 
    kmeans(centers = n_clusters, nstart = 20)
agrupado = km %>% 
    augment(m_transformado)
m_transformado = filmes %>% 
    mutate(bilh_scaled = as.vector(scale(log10(bilheteria))), 
           av_scaled = as.vector(scale(avaliacao))) 
agrupa_bilh_avaliacao<- function(df, k){
    df %>% 
        select(bilh_scaled, av_scaled) %>%
        kmeans(centers = k, 
               nstart = 20) %>% 
        augment(df) %>% 
        mutate(.cluster = as.character(.cluster))
}
agrupamentos = tibble(k = 1:6) %>% 
    mutate(agrupamento = map(k, ~ agrupa_bilh_avaliacao(m_transformado, .))) %>% 
    unnest(agrupamento)
 
agrupamentos %>%
    ggplot(aes(
        x = avaliacao,
        y = bilheteria,
        label = filme,
        colour = .cluster
    )) +
    geom_point(size = 2, alpha = .8) +
    facet_wrap( ~ k) +
    scale_y_log10()
    
```



```{r}
p = agrupado %>%
    ggplot(aes(x = avaliacao, y = bilheteria, color = .cluster, label = filme))  +
    geom_point(size = 2) +
    scale_y_log10() 
ggplotly(p)
```







